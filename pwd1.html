<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Password Manager</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f7fa;
      }

      .container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: space-between;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
        flex: 1;
        min-width: 300px;
      }

      h1,
      h2,
      h3 {
        color: #2c3e50;
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
      }

      input,
      button {
        padding: 10px;
        margin: 8px 0;
        border-radius: 4px;
        border: 1px solid #ddd;
        width: 100%;
        box-sizing: border-box;
      }

      input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      }

      button {
        background-color: #3498db;
        color: white;
        cursor: pointer;
        font-weight: bold;
        border: none;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #2980b9;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        background: white;
        border-radius: 8px;
        overflow: hidden;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      th {
        background-color: #3498db;
        color: white;
        font-weight: 500;
      }

      tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      tr:hover {
        background-color: #f1f1f1;
      }

      .status-message {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        text-align: center;
      }

      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .password-info {
        margin-top: 20px;
        font-size: 0.9em;
        color: #666;
      }

      .hide {
        display: none;
      }

      /* For mobile */
      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }
      }

      /* New styles for iterations slider */
      .range-container {
        margin: 15px 0;
      }

      .range-container label {
        display: block;
        margin-bottom: 5px;
      }

      .slider-with-value {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      input[type='range'] {
        flex-grow: 1;
      }

      .iterations-value {
        min-width: 80px;
        text-align: center;
        font-weight: bold;
      }

      .performance-info {
        margin-top: 10px;
        padding: 8px;
        background-color: #eef7fd;
        border-radius: 4px;
        border-left: 4px solid #3498db;
      }
    </style>
  </head>
  <body>
    <h1>Secure Password Manager with Performance Tracking</h1>

    <div class="container">
      <div class="card">
        <h2>Register New User</h2>
        <div id="registerStatus" class="status-message hide"></div>
        <form id="registerForm">
          <input type="text" id="newUsername" placeholder="Username" required />
          <input
            type="password"
            id="newPassword"
            placeholder="Password"
            required
          />

          <div class="range-container">
            <label for="registerIterations">PBKDF2 Iterations:</label>
            <div class="slider-with-value">
              <input
                type="range"
                id="registerIterations"
                min="10000"
                max="500000"
                step="10000"
                value="100000"
              />
              <span id="registerIterationsValue" class="iterations-value"
                >100,000</span
              >
            </div>
          </div>

          <button type="submit">Register</button>
        </form>
        <div class="password-info">
          <p>Password will be securely stored using:</p>
          <ul>
            <li>Unique salt per password</li>
            <li>PBKDF2 with SHA-256</li>
            <li>User-configurable iterations</li>
            <li>256-bit derived key</li>
          </ul>
        </div>
        <div id="registerPerformance" class="performance-info hide">
          <p><strong>Performance results:</strong></p>
          <p id="registerTimeResult"></p>
        </div>
      </div>

      <div class="card">
        <h2>Login</h2>
        <div id="loginStatus" class="status-message hide"></div>
        <form id="loginForm">
          <input type="text" id="username" placeholder="Username" required />
          <input
            type="password"
            id="password"
            placeholder="Password"
            required
          />
          <button type="submit">Login</button>
        </form>
        <div id="loginPerformance" class="performance-info hide">
          <p><strong>Performance results:</strong></p>
          <p id="loginTimeResult"></p>
        </div>
      </div>

      <div class="card">
        <h2>Change Password</h2>
        <div id="changeStatus" class="status-message hide"></div>
        <form id="changePasswordForm">
          <input
            type="text"
            id="changeUsername"
            placeholder="Username"
            required
          />
          <input
            type="password"
            id="currentPassword"
            placeholder="Current Password"
            required
          />
          <input
            type="password"
            id="newPassword2"
            placeholder="New Password"
            required
          />

          <div class="range-container">
            <label for="changeIterations">New PBKDF2 Iterations:</label>
            <div class="slider-with-value">
              <input
                type="range"
                id="changeIterations"
                min="10000"
                max="500000"
                step="10000"
                value="100000"
              />
              <span id="changeIterationsValue" class="iterations-value"
                >100,000</span
              >
            </div>
          </div>

          <button type="submit">Change Password</button>
        </form>
        <div id="changePerformance" class="performance-info hide">
          <p><strong>Performance results:</strong></p>
          <p id="changeTimeResult"></p>
        </div>
      </div>

      <div class="card">
        <h2>Delete User</h2>
        <div id="deleteStatus" class="status-message hide"></div>
        <form id="deleteUserForm">
          <input
            type="text"
            id="deleteUsername"
            placeholder="Username"
            required
          />
          <input
            type="password"
            id="deletePassword"
            placeholder="Password"
            required
          />
          <button type="submit" style="background-color: #e74c3c">
            Delete User
          </button>
        </form>
        <p class="password-info">
          This action cannot be undone. User will be permanently removed.
        </p>
      </div>
    </div>

    <div class="card">
      <h2>User Database</h2>
      <p>
        This table shows all registered users and their security details
        including performance metrics
      </p>
      <table id="userTable">
        <thead>
          <tr>
            <th>Username</th>
            <th>Salt (Hex)</th>
            <th>Hash (Hex, first 16 chars)</th>
            <th>Iterations</th>
            <th>Encoding Time (ms)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          <!-- User data will be populated here -->
        </tbody>
      </table>
    </div>

    <script>
      /**
       * Secure Password Storage and Verification Tool with Performance Tracking
       */
      class PasswordManager {
        constructor(defaultIterations = 100000, keyLength = 256) {
          this.defaultIterations = defaultIterations;
          this.keyLength = keyLength;
          this.passwordStore = new Map();

          // Try to load data from localStorage
          this.loadFromStorage();
        }

        // Storage methods
        saveToStorage() {
          // Convert Map to array of entries
          const entries = Array.from(this.passwordStore.entries());

          // Convert to JSON string and store
          localStorage.setItem('passwordManager', JSON.stringify(entries));
        }

        loadFromStorage() {
          const stored = localStorage.getItem('passwordManager');
          if (stored) {
            try {
              // Parse JSON and convert back to Map
              const entries = JSON.parse(stored);
              this.passwordStore = new Map(entries);
            } catch (e) {
              console.error('Failed to load from storage:', e);
            }
          }
        }

        clearStorage() {
          localStorage.removeItem('passwordManager');
          this.passwordStore.clear();
        }

        // Core crypto methods
        generateSalt(length = 16) {
          const salt = new Uint8Array(length);
          crypto.getRandomValues(salt);
          return salt;
        }

        stringToBuffer(str) {
          return new TextEncoder().encode(str);
        }

        bufferToHex(buffer) {
          return Array.from(new Uint8Array(buffer))
            .map((b) => b.toString(16).padStart(2, '0'))
            .join('');
        }

        hexToBuffer(hexString) {
          const bytes = new Uint8Array(hexString.length / 2);
          for (let i = 0; i < hexString.length; i += 2) {
            bytes[i / 2] = parseInt(hexString.substr(i, 2), 16);
          }
          return bytes.buffer;
        }

        async deriveKey(password, salt, iterations = this.defaultIterations) {
          const passwordBuffer = this.stringToBuffer(password);

          const importedKey = await crypto.subtle.importKey(
            'raw',
            passwordBuffer,
            { name: 'PBKDF2' },
            false,
            ['deriveBits']
          );

          return crypto.subtle.deriveBits(
            {
              name: 'PBKDF2',
              salt: salt,
              iterations: iterations,
              hash: 'SHA-256',
            },
            importedKey,
            this.keyLength
          );
        }

        // User management methods with performance tracking
        async storePassword(
          username,
          password,
          iterations = this.defaultIterations
        ) {
          // Check if username already exists
          if (this.passwordStore.has(username)) {
            throw new Error('Username already exists');
          }

          const salt = this.generateSalt();

          // Start time measurement
          const startTime = performance.now();
          const derivedKey = await this.deriveKey(password, salt, iterations);
          const endTime = performance.now();
          const timeTaken = endTime - startTime;

          const passwordData = {
            salt: this.bufferToHex(salt),
            hash: this.bufferToHex(derivedKey),
            iterations: iterations,
            timeTaken: timeTaken.toFixed(2),
          };

          this.passwordStore.set(username, passwordData);
          this.saveToStorage();

          return { ...passwordData, timeTaken };
        }

        async verifyPassword(username, password) {
          const passwordData = this.passwordStore.get(username);

          if (!passwordData) {
            return { isValid: false };
          }

          const salt = new Uint8Array(this.hexToBuffer(passwordData.salt));

          // Start time measurement
          const startTime = performance.now();
          const derivedKey = await this.deriveKey(
            password,
            salt,
            passwordData.iterations
          );
          const endTime = performance.now();
          const timeTaken = endTime - startTime;

          const derivedKeyHex = this.bufferToHex(derivedKey);
          const isValid = derivedKeyHex === passwordData.hash;

          return {
            isValid,
            timeTaken: timeTaken.toFixed(2),
            iterations: passwordData.iterations,
          };
        }

        getUsers() {
          return Array.from(this.passwordStore.keys());
        }

        getUserData() {
          return Array.from(this.passwordStore.entries()).map(
            ([username, data]) => ({
              username,
              ...data,
            })
          );
        }

        async changePassword(
          username,
          oldPassword,
          newPassword,
          newIterations
        ) {
          const verificationResult = await this.verifyPassword(
            username,
            oldPassword
          );

          if (!verificationResult.isValid) {
            return { changed: false };
          }

          // Remove the old entry first to avoid the "already exists" error
          this.passwordStore.delete(username);
          const storeResult = await this.storePassword(
            username,
            newPassword,
            newIterations
          );

          return {
            changed: true,
            oldIterations: verificationResult.iterations,
            oldTime: verificationResult.timeTaken,
            newIterations: newIterations,
            newTime: storeResult.timeTaken,
          };
        }

        async deleteUser(username, password) {
          const verificationResult = await this.verifyPassword(
            username,
            password
          );

          if (!verificationResult.isValid) {
            return false;
          }

          const deleted = this.passwordStore.delete(username);
          this.saveToStorage();
          return deleted;
        }
      }

      // Initialize app
      const passwordManager = new PasswordManager();

      // DOM references
      const registerForm = document.getElementById('registerForm');
      const loginForm = document.getElementById('loginForm');
      const changePasswordForm = document.getElementById('changePasswordForm');
      const userTableBody = document.getElementById('userTableBody');

      // Status messages
      const registerStatus = document.getElementById('registerStatus');
      const loginStatus = document.getElementById('loginStatus');
      const changeStatus = document.getElementById('changeStatus');

      // Performance info elements
      const registerPerformance = document.getElementById(
        'registerPerformance'
      );
      const registerTimeResult = document.getElementById('registerTimeResult');
      const loginPerformance = document.getElementById('loginPerformance');
      const loginTimeResult = document.getElementById('loginTimeResult');
      const changePerformance = document.getElementById('changePerformance');
      const changeTimeResult = document.getElementById('changeTimeResult');

      // Iterations slider elements
      const registerIterations = document.getElementById('registerIterations');
      const registerIterationsValue = document.getElementById(
        'registerIterationsValue'
      );
      const changeIterations = document.getElementById('changeIterations');
      const changeIterationsValue = document.getElementById(
        'changeIterationsValue'
      );

      // Helper function to show status messages
      function showStatus(element, message, isSuccess) {
        element.textContent = message;
        element.classList.remove('hide', 'success', 'error');
        element.classList.add(isSuccess ? 'success' : 'error');

        // Auto-hide after 3 seconds
        setTimeout(() => {
          element.classList.add('hide');
        }, 3000);
      }

      // Format iteration numbers with commas
      function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      // Update iterations display on slider change
      registerIterations.addEventListener('input', function () {
        registerIterationsValue.textContent = formatNumber(this.value);
      });

      changeIterations.addEventListener('input', function () {
        changeIterationsValue.textContent = formatNumber(this.value);
      });

      // Update the user table
      function updateUserTable() {
        userTableBody.innerHTML = '';

        const userData = passwordManager.getUserData();

        if (userData.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="6">No users registered yet</td>';
          userTableBody.appendChild(row);
          return;
        }

        userData.forEach((user) => {
          const row = document.createElement('tr');

          // Show only first 16 chars of hash for brevity
          const truncatedHash = user.hash.substring(0, 16) + '...';

          row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.salt}</td>
            <td>${truncatedHash}</td>
            <td>${formatNumber(user.iterations)}</td>
            <td>${user.timeTaken} ms</td>
            <td>
                <button type="button" class="delete-btn" data-username="${
                  user.username
                }" 
                    style="background-color: #e74c3c; width: auto; padding: 5px 10px;">
                    Delete
                </button>
            </td>
          `;

          userTableBody.appendChild(row);
        });
      }

      // Register form submission
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('newUsername').value;
        const password = document.getElementById('newPassword').value;
        const iterations = parseInt(registerIterations.value);

        try {
          const result = await passwordManager.storePassword(
            username,
            password,
            iterations
          );
          showStatus(
            registerStatus,
            `User ${username} registered successfully!`,
            true
          );

          // Show performance data
          registerTimeResult.textContent = `Password encoding took ${
            result.timeTaken
          } ms with ${formatNumber(iterations)} iterations.`;
          registerPerformance.classList.remove('hide');

          registerForm.reset();
          registerIterations.value = 100000;
          registerIterationsValue.textContent = '100,000';
          updateUserTable();
        } catch (error) {
          showStatus(registerStatus, error.message, false);
        }
      });

      // Login form submission
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        const result = await passwordManager.verifyPassword(username, password);

        if (result.isValid) {
          showStatus(loginStatus, `Welcome back, ${username}!`, true);

          // Show performance data
          loginTimeResult.textContent = `Password verification took ${
            result.timeTaken
          } ms with ${formatNumber(result.iterations)} iterations.`;
          loginPerformance.classList.remove('hide');

          loginForm.reset();
        } else {
          showStatus(loginStatus, 'Invalid username or password', false);
          loginPerformance.classList.add('hide');
        }
      });

      // Change password form submission
      changePasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('changeUsername').value;
        const currentPassword =
          document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword2').value;
        const newIterations = parseInt(changeIterations.value);

        const result = await passwordManager.changePassword(
          username,
          currentPassword,
          newPassword,
          newIterations
        );

        if (result.changed) {
          showStatus(
            changeStatus,
            `Password for ${username} changed successfully!`,
            true
          );

          // Show performance comparison
          changeTimeResult.innerHTML = `
            <strong>Previous password:</strong> ${
              result.oldTime
            } ms with ${formatNumber(result.oldIterations)} iterations<br>
            <strong>New password:</strong> ${
              result.newTime
            } ms with ${formatNumber(result.newIterations)} iterations
          `;
          changePerformance.classList.remove('hide');

          changePasswordForm.reset();
          changeIterations.value = 100000;
          changeIterationsValue.textContent = '100,000';
          updateUserTable();
        } else {
          showStatus(
            changeStatus,
            'Invalid username or current password',
            false
          );
          changePerformance.classList.add('hide');
        }
      });

      // Delete form submission
      const deleteUserForm = document.getElementById('deleteUserForm');
      const deleteStatus = document.getElementById('deleteStatus');

      deleteUserForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('deleteUsername').value;
        const password = document.getElementById('deletePassword').value;

        const deleted = await passwordManager.deleteUser(username, password);

        if (deleted) {
          showStatus(
            deleteStatus,
            `User ${username} deleted successfully!`,
            true
          );
          deleteUserForm.reset();
          updateUserTable();
        } else {
          showStatus(deleteStatus, 'Invalid username or password', false);
        }
      });

      // Delete button in the table
      userTableBody.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-btn')) {
          const username = e.target.getAttribute('data-username');

          if (
            confirm(
              `Are you sure you want to delete user "${username}"?\nThis action cannot be undone.`
            )
          ) {
            // Prompt for password
            const password = prompt(
              `Enter password for "${username}" to confirm deletion:`
            );

            if (password) {
              const deleted = await passwordManager.deleteUser(
                username,
                password
              );

              if (deleted) {
                alert(`User ${username} deleted successfully!`);
                updateUserTable();
              } else {
                alert('Invalid password. Deletion canceled.');
              }
            }
          }
        }
      });

      // Initialize user table
      updateUserTable();
    </script>
  </body>
</html>
